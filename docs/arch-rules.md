# Архитектурные Правила и Паттерны

## 1. Введение

Этот документ определяет архитектурные правила и паттерны, которые должны соблюдаться при разработке проекта. Цель — обеспечить чистоту, масштабируемость и поддерживаемость кодовой базы.

---

## 2. Архитектура Бэкенда (Express.js)

Для бэкенда применяется **Многоуровневая архитектура (Layered Architecture)**. Этот подход обеспечивает строгое разделение ответственности (Separation of Concerns), что упрощает тестирование, рефакторинг и понимание кода.

**Поток запроса:** `Request -> Routes -> Controllers -> Services -> Data Access Layer (Prisma)`

### 2.1. Описание Уровней

#### 1. Уровень Маршрутизации (Routes)

- **Расположение:** `/server/src/routes`
- **Ответственность:**
  - Определение HTTP-эндпоинтов (например, `/api/login`).
  - Привязка эндпоинтов к HTTP-методам (`GET`, `POST`, и т.д.).
  - (Опционально) Валидация входящих данных (тела запроса, параметров).
  - Передача управления на соответствующий метод Контроллера.
- **Правила:** Не содержит бизнес-логики. Только маршрутизация.

#### 2. Уровень Контроллеров (Controllers)

- **Расположение:** `/server/src/controllers`
- **Ответственность:**
  - "Оркестрация" обработки запроса.
  - Извлечение данных из объектов `request` и `response`.
  - Вызов одного или нескольких методов Уровня Сервисов.
  - Формирование и отправка HTTP-ответа (JSON, статус-коды).
- **Правила:** Не содержит бизнес-логики и прямых запросов к базе данных. Является тонким "клеем" между HTTP-миром и логикой приложения.

#### 3. Уровень Сервисов (Services)

- **Расположение:** `/server/src/services`
- **Ответственность:**
  - **Реализация всей бизнес-логики приложения.**
  - Координация операций, работа с данными, выполнение вычислений.
  - Вызов методов Уровня Доступа к Данным для взаимодействия с БД.
- **Правила:** Полностью независим от HTTP. Не знает о существовании `request` и `response`. Может быть переиспользован в других частях приложения (например, в консольных скриптах).

#### 4. Уровень Доступа к Данным (Data Access Layer - DAL)

- **Реализация:** Prisma Client.
- **Расположение:** `/server/src/lib/prisma.ts` (синглтон-инстанс).
- **Ответственность:**
  - Единственная точка взаимодействия с базой данных.
  - Выполнение всех CRUD-операций (Create, Read, Update, Delete).

---

## 3. Архитектура Фронтенда (Next.js & Feature-Sliced Design)

Для фронтенда применяется методология **Feature-Sliced Design (FSD)**, адаптированная под реалии **Next.js App Router** и его серверно-клиентской модели компонентов.

### 3.1. Основные Принципы Адаптации

- **Next.js `app` Directory = FSD `pages` Layer:** Маршрутизация и структура страниц полностью управляются каталогом `app`. Файлы `page.tsx` и `layout.tsx` являются точками входа и композиции для нижележащих слоев.
- **Server Components по умолчанию:** Все компоненты должны быть Серверными по умолчанию. Директива `'use client'` используется только тогда, когда компонент требует интерактивности или браузерных API (`useState`, `useEffect`, `onClick` и т.д.).

### 3.2. Структура Слоев (от верхнего к нижнему)

#### 1. `app`

- **Расположение:** `/client/src/app`
- **Ответственность:** Маршрутизация, определение метаданных, композиция страниц из виджетов и фич. Файлы `page.tsx` не должны содержать сложной логики или разметки, их главная задача — собрать UI из готовых блоков.

#### 2. `widgets`

- **Расположение:** `/client/src/widgets`
- **Ответственность:** Композиционные, самодостаточные блоки UI. Собирают в себе фичи и сущности в единый смысловой блок.
- **Примеры:** `<Header />`, `<Sidebar />`, `<ProfileCard />`.
- **Тип:** Часто являются Серверными Компонентами, которые могут принимать интерактивные Клиентские Компоненты в качестве дочерних элементов (`children`).

#### 3. `features`

- **Расположение:** `/client/src/features`
- **Ответственность:** Реализация бизнес-сценариев и пользовательских действий. Этот слой приносит пользу бизнесу.
- **Примеры:** `<LoginForm />`, `<RegisterForm />`, `<ChangeRoleButton />`.
- **Тип:** Часто являются Клиентскими Компонентами (`'use client'`), так как содержат состояние и обработчики событий.

#### 4. `entities`

- **Расположение:** `/client/src/entities`
- **Ответственность:** Представление бизнес-сущностей. Каркас приложения.
- **Примеры:** `<UserAvatar user={...} />`, `<RoleBadge role={...} />`.
- **Тип:** Чаще всего являются Серверными Компонентами, так как просто отображают переданные данные.

#### 5. `shared`

- **Расположение:** `/client/src/shared`
- **Ответственность:** Переиспользуемый код, не имеющий отношения к бизнес-логике.
- **Подкаталоги:**
  - `ui/`: UI-кит (например, `<Button />`, `<Input />`, `<Spinner />`). Часто это Клиентские Компоненты.
  - `lib/`: Вспомогательные функции и утилиты (например, `formatDate`).
  - `api/`: Функции для взаимодействия с API (в нашем случае, здесь будет находиться `lib/flags.ts`).
  - `config/`: Конфигурационные файлы.
- **Правила:** Этот слой не должен зависеть ни от одного из вышележащих слоев.
