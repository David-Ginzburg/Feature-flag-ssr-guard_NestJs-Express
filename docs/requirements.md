# Технические Требования: Full-Stack Приложение с Фича-Флагами

## 1. Обзор Проекта

Этот документ описывает технические требования для создания full-stack приложения. Приложение будет включать бэкенд на Express.js и фронтенд на Next.js 16. Ключевой функционал — аутентификация пользователей по ролям и управление доступом к UI-компонентам с помощью серверных фича-флагов.

### 1.1. Архитектура

- **Бэкенд (`/server`):** REST API на Express.js, отвечающий за аутентификацию, управление пользователями и предоставление фича-флагов.
- **Фронтенд (`/client`):** Серверный рендеринг (SSR) на Next.js. UI динамически изменяется на сервере в зависимости от фича-флагов.
- **База Данных:** Облачный PostgreSQL (Neon), управляемый через Prisma ORM.
- **Развертывание:**
  - Бэкенд развертывается на **Render** из Docker-образа.
  - Фронтенд развертывается на **Vercel**.
- **Локальная разработка:** Полностью контейнеризирована с помощью **Docker Compose**.

## 2. Спецификации Бэкенда (`/server`)

### 2.1. Технологический Стек

- Node.js
- Express.js
- TypeScript
- Prisma (ORM для PostgreSQL)
- `jsonwebtoken` для создания JWT
- `bcryptjs` для хэширования паролей
- `cookie-parser` для работы с cookie

### 2.2. Схема Базы Данных (`schema.prisma`)

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
}
```

### 2.3. Определения API Эндпоинтов

#### `POST /api/register`

- **Описание:** Регистрация нового пользователя.
- **Тело запроса (Request Body):** `{ "email": "string", "password": "string", "role": "ADMIN" | "EDITOR" | "VIEWER" }`
- **Ответ (Success):** `201 Created` с телом `{ "id": "string", "email": "string", "role": "string" }`.
- **Действия:** Хэширует пароль, создает запись в таблице `User`.

#### `POST /api/login`

- **Описание:** Аутентификация пользователя.
- **Тело запроса (Request Body):** `{ "email": "string", "password": "string" }`
- **Ответ (Success):** `200 OK` с телом `{ "id": "string", "email": "string", "role": "string" }`. Устанавливает `httpOnly` cookie с именем `auth_token`, содержащий JWT.
- **Ответ (Error):** `401 Unauthorized`.
- **Действия:** Находит пользователя, сравнивает хэш пароля, генерирует JWT.

#### `GET /api/me`

- **Описание:** Получение данных о текущем аутентифицированном пользователе.
- **Аутентификация:** Требует наличия валидного `auth_token` в cookie.
- **Ответ (Success):** `200 OK` с телом `{ "id": "string", "email": "string", "role": "string" }`.
- **Ответ (Error):** `401 Unauthorized`.

#### `GET /api/flags`

- **Описание:** Получение набора фича-флагов для текущего пользователя.
- **Аутентификация:** Требует наличия валидного `auth_token` в cookie.
- **Ответ (Success):** `200 OK` с телом, соответствующим роли пользователя (например, `{ "canViewAnalytics": true, "canEditContent": true, ... }`).
- **Ответ (Guest):** Если токен отсутствует или невалиден, возвращает `200 OK` с набором флагов по умолчанию для гостя (все `false`).

## 3. Спецификации Фронтенда (`/client`)

### 3.1. Технологический Стек

- Next.js 16 (App Router)
- React 18
- TypeScript
- Tailwind CSS

### 3.2. Ключевая Логика

#### `lib/flags.ts`

- **Функция `getFeatureFlags()`:**
  - Должна использовать директиву `'use cache: private'`.
  - Должна быть асинхронной.
  - Должна читать `cookies` из `next/headers` и передавать их в `fetch`-запросе к бэкенду (`GET /api/flags`).
  - URL бэкенда должен браться из переменной окружения `process.env.NEXT_PUBLIC_API_URL`.

### 3.3. Структура Страниц

| Роут         | Тип Компонента | Описание                                                                                        |
| :----------- | :------------- | :---------------------------------------------------------------------------------------------- |
| `/`          | Серверный      | Главная страница. Показывает/скрывает `<AnalyticsWidget />` на основе флага `canViewAnalytics`. |
| `/dashboard` | Серверный      | Показывает `<AdminPanel />` или обычный дашборд на основе флага `showAdminDashboard`.           |
| `/settings`  | Серверный      | Показывает форму настроек только при наличии флага `canAccessSettings`.                         |
| `/login`     | Клиентский     | Страница с формой для входа.                                                                    |
| `/register`  | Клиентский     | Страница с формой для регистрации.                                                              |

## 4. Инфраструктура и Развертывание

### 4.1. Локальная Разработка

- Запуск всего стека осуществляется одной командой `docker-compose up`.
- Бэкенд доступен на `localhost:4000`.
- Фронтенд доступен на `localhost:3000`.
- Строка подключения к БД Neon должна храниться в корневом `.env` файле, который не коммитится в Git.

### 4.2. CI/CD (GitHub Actions)

- Воркфлоу `.github/workflows/docker-build.yml` должен запускаться при пуше в `main`.
- Его задача — валидация того, что Docker-образы успешно собираются. Он **не деплоит** приложение.
- Он должен использовать `secrets.DATABASE_URL` из GitHub Secrets для шага `prisma generate`.

### 4.3. Развертывание (Production)

- **Бэкенд (Express):**
  - Деплоится на **Render** с использованием конфигурационного файла `render.yaml`.
  - Использует бесплатный тариф (`plan: free`).
  - `DATABASE_URL` и `JWT_SECRET` должны быть настроены как **Secrets** в дашборде Render.
- **Фронтенд (Next.js):**
  - Деплоится на **Vercel**.
  - В настройках проекта Vercel указывается **Root Directory** как `client`.
  - В настройках проекта Vercel должна быть установлена переменная окружения `NEXT_PUBLIC_API_URL`, указывающая на публичный URL развернутого на Render бэкенда.
